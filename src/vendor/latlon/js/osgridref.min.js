/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -   */
/*  Ordnance Survey Grid Reference functions            (c) Chris Veness 2005-2015 / MIT Licence  */
/*  Formulation implemented here due to Thomas, Redfearn, etc is as published by OS, but is       */
/*  inferior to KrÃ¼ger as used by e.g. Karney 2011.                          */
/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - -- - - - - - - -  */
"use strict";function OsGridRef(a,b){return this instanceof OsGridRef?(this.easting=Number(a),void(this.northing=Number(b))):new OsGridRef(a,b)}if("undefined"!=typeof module&&module.exports)var LatLon=require("./latlon-ellipsoidal.js");OsGridRef.latLonToOsGrid=function(a){if(!(a instanceof LatLon))throw new TypeError("point is not LatLon object");a.datum!=LatLon.datum.OSGB36&&(a=a.convertDatum(LatLon.datum.OSGB36));var b=a.lat.toRadians(),c=a.lon.toRadians(),d=6377563.396,e=6356256.909,f=.9996012717,g=49..toRadians(),h=(-2).toRadians(),i=-1e5,j=4e5,k=1-e*e/(d*d),l=(d-e)/(d+e),m=l*l,n=l*l*l,o=Math.cos(b),p=Math.sin(b),q=d*f/Math.sqrt(1-k*p*p),r=d*f*(1-k)/Math.pow(1-k*p*p,1.5),s=q/r-1,t=(1+l+5/4*m+5/4*n)*(b-g),u=(3*l+3*l*l+21/8*n)*Math.sin(b-g)*Math.cos(b+g),v=(15/8*m+15/8*n)*Math.sin(2*(b-g))*Math.cos(2*(b+g)),w=35/24*n*Math.sin(3*(b-g))*Math.cos(3*(b+g)),x=e*f*(t-u+v-w),y=o*o*o,z=y*o*o,A=Math.tan(b)*Math.tan(b),B=A*A,C=x+i,D=q/2*p*o,E=q/24*p*y*(5-A+9*s),F=q/720*p*z*(61-58*A+B),G=q*o,H=q/6*y*(q/r-A),I=q/120*z*(5-18*A+B+14*s-58*A*s),J=c-h,K=J*J,L=K*J,M=L*J,N=M*J,O=N*J,P=C+D*K+E*M+F*O,Q=j+G*J+H*L+I*N;return P=Number(P.toFixed(3)),Q=Number(Q.toFixed(3)),new OsGridRef(Q,P)},OsGridRef.osGridToLatLon=function(a,b){if(!(a instanceof OsGridRef))throw new TypeError("gridref is not OsGridRef object");void 0===b&&(b=LatLon.datum.WGS84);var c=a.easting,d=a.northing,e=6377563.396,f=6356256.909,g=.9996012717,h=49*Math.PI/180,i=-2*Math.PI/180,j=-1e5,k=4e5,l=1-f*f/(e*e),m=(e-f)/(e+f),n=m*m,o=m*m*m,p=h,q=0;do{p=(d-j-q)/(e*g)+p;var r=(1+m+5/4*n+5/4*o)*(p-h),s=(3*m+3*m*m+21/8*o)*Math.sin(p-h)*Math.cos(p+h),t=(15/8*n+15/8*o)*Math.sin(2*(p-h))*Math.cos(2*(p+h)),u=35/24*o*Math.sin(3*(p-h))*Math.cos(3*(p+h));q=f*g*(r-s+t-u)}while(d-j-q>=1e-5);var v=Math.cos(p),w=Math.sin(p),x=e*g/Math.sqrt(1-l*w*w),y=e*g*(1-l)/Math.pow(1-l*w*w,1.5),z=x/y-1,A=Math.tan(p),B=A*A,C=B*B,D=C*B,E=1/v,F=x*x*x,G=F*x*x,H=G*x*x,I=A/(2*y*x),J=A/(24*y*F)*(5+3*B+z-9*B*z),K=A/(720*y*G)*(61+90*B+45*C),L=E/x,M=E/(6*F)*(x/y+2*B),N=E/(120*G)*(5+28*B+24*C),O=E/(5040*H)*(61+662*B+1320*C+720*D),P=c-k,Q=P*P,R=Q*P,S=Q*Q,T=R*Q,U=S*Q,V=T*Q;p=p-I*Q+J*S-K*U;var W=i+L*P-M*R+N*T-O*V,X=new LatLon(p.toDegrees(),W.toDegrees(),LatLon.datum.OSGB36);return b!=LatLon.datum.OSGB36&&(X=X.convertDatum(b)),X},OsGridRef.parse=function(a){a=String(a).trim();var b=a.match(/^(\d+),\s*(\d+)$/);if(b)return new OsGridRef(b[1],b[2]);var c=a.toUpperCase().charCodeAt(0)-"A".charCodeAt(0),d=a.toUpperCase().charCodeAt(1)-"A".charCodeAt(0);c>7&&c--,d>7&&d--;var e=(c-2)%5*5+d%5,f=19-5*Math.floor(c/5)-Math.floor(d/5);return 0>e||e>6||0>f||f>12?new OsGridRef(NaN,NaN):(a=a.slice(2).replace(/ /g,""),e+=a.slice(0,a.length/2),f+=a.slice(a.length/2),new OsGridRef(e,f))},OsGridRef.prototype.toString=function(a){a=void 0===a?10:Number(a);var b=this.easting,c=this.northing;if(isNaN(b)||isNaN(c))throw new Error("Invalid grid reference");if(0==a)return b.pad(6)+","+c.pad(6);var d=Math.floor(b/1e5),e=Math.floor(c/1e5);if(0>d||d>6||0>e||e>12)return"";var f=19-e-(19-e)%5+Math.floor((d+10)/5),g=5*(19-e)%25+d%5;f>7&&f++,g>7&&g++;var h=String.fromCharCode(f+"A".charCodeAt(0),g+"A".charCodeAt(0));b=Math.floor(b%1e5/Math.pow(10,5-a/2)),c=Math.floor(c%1e5/Math.pow(10,5-a/2));var i=h+" "+b.pad(a/2)+" "+c.pad(a/2);return i},void 0===String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),void 0===Number.prototype.pad&&(Number.prototype.pad=function(a){for(var b=this.toString();b.length<a;)b="0"+b;return b}),"undefined"!=typeof module&&module.exports&&(module.exports=OsGridRef),"function"==typeof define&&define.amd&&define([],function(){return OsGridRef});